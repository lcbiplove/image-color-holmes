name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_GHCR_USER: ${{ secrets.DOCKER_GHCR_USER }}
  DOCKER_GHCR_PASS: ${{ secrets.DOCKER_GHCR_PASS }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_SERVER_USER: ${{ secrets.SSH_SERVER_USER }}
  SSH_SERVER_IP: ${{ secrets.SSH_SERVER_IP }}
  DOMAIN_NAME_VAR: ${{ vars.DOMAIN_NAME_VAR }}
  DOMAIN_EMAIL_VAR: ${{ vars.DOMAIN_EMAIL_VAR }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Log in to Github Container Registry
        run: |
          echo $DOCKER_GHCR_PASS | docker login ghcr.io -u $DOCKER_GHCR_USER --password-stdin

      - name: Build and push Docker image using Docker Compose
        run: |
          docker compose build
          docker compose push

  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Deploy with Ansible from the server
        uses: appleboy/ssh-action@master
        with:
          host: $SSH_SERVER_IP
          username: $SSH_SERVER_USER
          key: $SSH_PRIVATE_KEY
          port: 22
          script: |
            ansible-playbook ansible/playbook.yml -i "localhost," -c local \
              --extra-vars "domain_name=$DOMAIN_NAME_VAR docker_username=$DOCKER_GHCR_USER docker_password=$DOCKER_GHCR_PASS domain_email=$DOMAIN_EMAIL_VAR"